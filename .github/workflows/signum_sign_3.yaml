name: Sign document with Signum Container Agent (basic)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "filestosign/**"

permissions:
  contents: read

jobs:
  sign:
    runs-on: ubuntu-latest
    env:
      # Generic repo base (NOT Docker registry)
      JFROG_BASE_URL: https://keyfactor.jfrog.io/artifactory
      JFROG_REPO: signum-bdewberry-testing

      # Path you described in the UI:
      # signum-bdewberry-testing > keyfactor > signum-linux-agent > latest
      AGENT_OBJECT_PATH: keyfactor/signum-linux-agent/latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Notes / Support Disclaimer
        shell: bash
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<'EOF'
          ## Signum Agent â€“ Support / Usage Notes
          Support issues: https://support.keyfactor.com/
          EOF

      - name: Detect presence of JFrog credentials
        id: detect_creds
        shell: bash
        env:
          JFROG_USERNAME: ${{ secrets.JFROG_USERNAME }}
          JFROG_TOKEN:    ${{ secrets.JFROG_TOKEN }}
        run: |
          set -euo pipefail
          creds_present="false"
          if [ -n "${JFROG_USERNAME:-}" ] && [ -n "${JFROG_TOKEN:-}" ]; then
            creds_present="true"
          fi
          echo "creds_present=${creds_present}" >> "$GITHUB_OUTPUT"
          echo "Detected creds_present=${creds_present}"

      - name: Download Signum linux agent (Generic repo)
        shell: bash
        env:
          CREDS_PRESENT: ${{ steps.detect_creds.outputs.creds_present }}
          JFROG_USERNAME: ${{ secrets.JFROG_USERNAME }}
          JFROG_TOKEN:    ${{ secrets.JFROG_TOKEN }}
        run: |
          set -euo pipefail

          mkdir -p signum-agent-download

          FILE_URL="${JFROG_BASE_URL}/${JFROG_REPO}/${AGENT_OBJECT_PATH}"
          OUT="signum-agent-download/signum-linux-agent-latest"

          echo "Attempting download from:"
          echo "${FILE_URL}"

          # Prefer anonymous first; if it fails and creds exist, retry with basic auth.
          if curl -fLsS -o "${OUT}" "${FILE_URL}"; then
            echo "Downloaded anonymously to ${OUT}"
          else
            echo "Anonymous download failed."
            if [ "${CREDS_PRESENT}" = "true" ]; then
              echo "Retrying with credentials..."
              curl -fLsS -u "${JFROG_USERNAME}:${JFROG_TOKEN}" -o "${OUT}" "${FILE_URL}"
              echo "Downloaded with credentials to ${OUT}"
            else
              echo "No JFrog credentials available. Add secrets JFROG_USERNAME and JFROG_TOKEN."
              exit 1
            fi
          fi

          echo "== File info =="
          ls -lah signum-agent-download
          file "${OUT}" || true

          # If it's an archive, extract it
          if file "${OUT}" | grep -qiE 'zip archive'; then
            echo "Detected ZIP; extracting..."
            unzip -o "${OUT}" -d signum-agent-download
          elif file "${OUT}" | grep -qiE 'gzip compressed|tar archive'; then
            echo "Detected tar/gz; extracting..."
            tar -xf "${OUT}" -C signum-agent-download || tar -xzf "${OUT}" -C signum-agent-download
          fi

          echo "### Downloaded Signum agent artifact" >> "$GITHUB_STEP_SUMMARY"
          echo "- Source: ${FILE_URL}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Output dir: signum-agent-download/" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload downloaded artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signum-agent-generic-download
          path: |
            signum-agent-download/**

      # ---- Optional: Keep your original container flow if you ALSO have a Docker repo image ----
      # If you still want to run the container agent image, keep your docker pull/run steps here,
      # but note: Docker images must come from a Docker repo, not this Generic repo.
