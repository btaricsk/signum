      - name: Download latest Signum linux agent (resolve real file via storage API)
        shell: bash
        env:
          JFROG_BASE_URL: https://keyfactor.jfrog.io/artifactory
          JFROG_REPO: signum-bdewberry-testing
          AGENT_PARENT_PATH: keyfactor/signum-linux-agent
          JFROG_USERNAME: ${{ secrets.JFROG_USERNAME }}
          JFROG_TOKEN:    ${{ secrets.JFROG_TOKEN }}
        run: |
          set -euo pipefail

          mkdir -p signum-agent-download

          FILE_PATH="$(python3 - <<'PY'
          import base64, json, os, sys, urllib.request, urllib.error

          base = os.environ["JFROG_BASE_URL"].rstrip("/")
          repo = os.environ["JFROG_REPO"]
          parent = os.environ["AGENT_PARENT_PATH"].strip("/")
          user = os.environ["JFROG_USERNAME"]
          token = os.environ["JFROG_TOKEN"]

          def get_json(url: str) -> dict:
            req = urllib.request.Request(url)
            auth = base64.b64encode(f"{user}:{token}".encode()).decode()
            req.add_header("Authorization", f"Basic {auth}")
            req.add_header("Accept", "application/json")
            with urllib.request.urlopen(req) as resp:
              return json.loads(resp.read().decode())

          def children(path: str):
            url = f"{base}/api/storage/{repo}/{path}"
            j = get_json(url)
            return [c["uri"].lstrip("/") for c in j.get("children", [])]

          def looks_like_file(name: str) -> bool:
            # Generic repos usually have extensions; this is a heuristic
            return "." in name.split("/")[-1]

          # 1) list parent
          kids = children(parent)
          if not kids:
            print(f"No children under {parent}", file=sys.stderr)
            sys.exit(1)

          # prefer 'latest' folder if present, else choose lexicographically last child
          chosen = f"{parent}/latest" if "latest" in kids else f"{parent}/" + sorted(kids)[-1]

          # 2) resolve down to a file
          def resolve_to_file(path: str) -> str:
            try:
              kids2 = children(path)
            except urllib.error.HTTPError as e:
              # If storage API returns non-JSON for a file, treat as file
              if e.code in (404, 400):
                return path
              raise

            if kids2:
              files = [k for k in kids2 if looks_like_file(k)]
              if files:
                return path.rstrip("/") + "/" + sorted(files)[0]
              # descend into first child folder
              return resolve_to_file(path.rstrip("/") + "/" + sorted(kids2)[0])
            return path

          print(resolve_to_file(chosen))
          PY
          )"

          echo "Resolved file path: ${FILE_PATH}"

          FILE_URL="${JFROG_BASE_URL%/}/${JFROG_REPO}/${FILE_PATH}"
          OUT="signum-agent-download/$(basename "${FILE_PATH}")"

          echo "Downloading from:"
          echo "${FILE_URL}"

          curl -fLsS -u "${JFROG_USERNAME}:${JFROG_TOKEN}" -o "${OUT}" "${FILE_URL}"

          echo "== Downloaded file info =="
          ls -lah signum-agent-download
          file "${OUT}" || true

          if file "${OUT}" | grep -qiE 'zip archive'; then
            echo "Detected ZIP; extracting..."
            unzip -o "${OUT}" -d signum-agent-download
          elif file "${OUT}" | grep -qiE 'gzip compressed|tar archive'; then
            echo "Detected tar/gz; extracting..."
            tar -xf "${OUT}" -C signum-agent-download || tar -xzf "${OUT}" -C signum-agent-download
          fi

          echo "### Downloaded Signum agent artifact" >> "$GITHUB_STEP_SUMMARY"
          echo "- Source: ${FILE_URL}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Output: ${OUT}" >> "$GITHUB_STEP_SUMMARY"
