name: Download Signum linux agent from JFrog Generic Repo

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "filestosign/**"

permissions:
  contents: read

jobs:
  sign:
    runs-on: ubuntu-latest
    env:
      # Generic repo base (NOT Docker registry)
      JFROG_BASE_URL: https://keyfactor.jfrog.io/artifactory
      JFROG_REPO: signum-bdewberry-testing

      # Parent folder (NOT "latest" as a file)
      AGENT_PARENT_PATH: keyfactor/signum-linux-agent

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Notes / Support Disclaimer
        shell: bash
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<'EOF'
          ## Signum Agent â€“ Support / Usage Notes
          Support issues: https://support.keyfactor.com/
          EOF

      - name: Validate JFrog credentials present
        shell: bash
        env:
          JFROG_USERNAME: ${{ secrets.JFROG_USERNAME }}
          JFROG_TOKEN:    ${{ secrets.JFROG_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${JFROG_USERNAME:-}" ] || [ -z "${JFROG_TOKEN:-}" ]; then
            echo "Missing secrets. Add JFROG_USERNAME and JFROG_TOKEN (API key/password recommended)."
            exit 1
          fi
          echo "JFrog credentials present."

      - name: Download latest Signum linux agent (resolve real file via storage API)
        shell: bash
        env:
          JFROG_USERNAME: ${{ secrets.JFROG_USERNAME }}
          JFROG_TOKEN:    ${{ secrets.JFROG_TOKEN }}
        run: |
          set -euo pipefail

          mkdir -p signum-agent-download

          storage_api () {
            local p="$1"
            curl -fsS -u "${JFROG_USERNAME}:${JFROG_TOKEN}" \
              "${JFROG_BASE_URL%/}/api/storage/${JFROG_REPO}/${p}"
          }

          echo "== Resolving agent file via storage API =="
          echo "Repo: ${JFROG_REPO}"
          echo "Parent: ${AGENT_PARENT_PATH}"

          FILE_PATH="$(python3 - <<'PY'
          import json, os, subprocess, sys

          repo = os.environ["JFROG_REPO"]
          parent = os.environ["AGENT_PARENT_PATH"].strip("/")

          def storage(path: str) -> dict:
            cmd = ["bash","-lc", f'storage_api "{path}"']
            out = subprocess.check_output(cmd, text=True)
            return json.loads(out)

          def looks_like_file(uri: str) -> bool:
            name = uri.strip("/").split("/")[-1]
            return "." in name  # crude but effective for generic repos

          # list children of parent
          parent_json = storage(parent)
          children = [c["uri"].lstrip("/") for c in parent_json.get("children", [])]
          if not children:
            print(f"No children found under {parent}", file=sys.stderr)
            sys.exit(1)

          # prefer "latest" folder if it exists, else choose lexicographically last child
          chosen = f"{parent}/latest" if "latest" in children else f"{parent}/" + sorted(children)[-1]

          def resolve_to_file(path: str) -> str:
            j = storage(path)
            kids = [c["uri"].lstrip("/") for c in j.get("children", [])]
            if kids:
              files = [k for k in kids if looks_like_file(k)]
              if files:
                return path.rstrip("/") + "/" + sorted(files)[0]
              # descend into first child folder
              return resolve_to_file(path.rstrip("/") + "/" + sorted(kids)[0])
            return path

          print(resolve_to_file(chosen))
          PY
          )"

          echo "Resolved file path: ${FILE_PATH}"

          FILE_URL="${JFROG_BASE_URL%/}/${JFROG_REPO}/${FILE_PATH}"
          OUT="signum-agent-download/$(basename "${FILE_PATH}")"

          echo "Downloading from:"
          echo "${FILE_URL}"
          curl -fLsS -u "${JFROG_USERNAME}:${JFROG_TOKEN}" -o "${OUT}" "${FILE_URL}"

          echo "== Downloaded file info =="
          ls -lah signum-agent-download
          file "${OUT}" || true

          # If it's an archive, extract it
          if file "${OUT}" | grep -qiE 'zip archive'; then
            echo "Detected ZIP; extracting..."
            unzip -o "${OUT}" -d signum-agent-download
          elif file "${OUT}" | grep -qiE 'gzip compressed|tar archive'; then
            echo "Detected tar/gz; extracting..."
            tar -xf "${OUT}" -C signum-agent-download || tar -xzf "${OUT}" -C signum-agent-download
          fi

          echo "### Downloaded Signum agent artifact" >> "$GITHUB_STEP_SUMMARY"
          echo "- Source: ${FILE_URL}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Output: ${OUT}" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload downloaded artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signum-agent-generic-download
          path: |
            signum-agent-download/**
