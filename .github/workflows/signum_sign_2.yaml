name: Sign document with Signum Container Agent (basic)

on:
  workflow_dispatch:
    inputs:
      signum_agent_image:
        description: "Container image to use (include tag). Avoid :latest for reliability."
        required: false
        default: "repo.keyfactor.com/images/signum-agent:4.60.2"
  push:
    branches: ["main"]
    paths:
      - "filestosign/**"

permissions:
  contents: read

jobs:
  sign:
    runs-on: ubuntu-latest
    env:
      SIGNUM_REGISTRY: repo.keyfactor.com
      DEFAULT_SIGNUM_AGENT_IMAGE: repo.keyfactor.com/images/signum-agent:4.60.2

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Notes / Support Disclaimer
        shell: bash
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<'EOF'
          ## Signum Container Agent with Signing Tools â€“ Support / Usage Notes
          Support issues: https://support.keyfactor.com/
          EOF

      - name: Resolve agent image ref
        id: img
        shell: bash
        run: |
          set -euo pipefail
          IMG="${{ inputs.signum_agent_image }}"
          if [ -z "${IMG}" ]; then
            IMG="${DEFAULT_SIGNUM_AGENT_IMAGE}"
          fi
          echo "image=${IMG}" >> "$GITHUB_OUTPUT"
          echo "Using agent image: ${IMG}"

      - name: Try anonymous docker pull (no login)
        id: anon_pull
        shell: bash
        env:
          SIGNUM_AGENT_IMAGE: ${{ steps.img.outputs.image }}
        run: |
          set -euo pipefail
          echo "=== Attempting anonymous docker pull of ${SIGNUM_AGENT_IMAGE} ==="
          if docker pull "${SIGNUM_AGENT_IMAGE}"; then
            echo "PULLED=anonymous" >> "$GITHUB_OUTPUT"
            echo "Anonymous pull succeeded."
          else
            echo "PULLED=failed" >> "$GITHUB_OUTPUT"
            echo "Anonymous pull failed."
          fi

      - name: Detect presence of JFrog credentials (set output)
        id: detect_creds
        shell: bash
        env:
          # map secrets into env so we can check them in shell (no secrets.* in if expressions)
          JFROG_USERNAME: ${{ secrets.JFROG_USERNAME }}
          JFROG_TOKEN:    ${{ secrets.JFROG_TOKEN }}
        run: |
          set -euo pipefail
          creds_present="false"
          if [ -n "${JFROG_USERNAME:-}" ] && [ -n "${JFROG_TOKEN:-}" ]; then
            creds_present="true"
          fi
          echo "creds_present=${creds_present}" >> "$GITHUB_OUTPUT"
          echo "Detected creds_present=${creds_present}"

      - name: Docker login (repo.keyfactor.com)
        if: ${{ steps.detect_creds.outputs.creds_present == 'true' && steps.anon_pull.outputs.PULLED != 'anonymous' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.SIGNUM_REGISTRY }}
          username: ${{ secrets.JFROG_USERNAME }}
          password: ${{ secrets.JFROG_TOKEN }}
          logout: true

      - name: Manual docker login fallback (password-stdin) - diagnostic
        if: ${{ steps.detect_creds.outputs.creds_present == 'true' && steps.anon_pull.outputs.PULLED != 'anonymous' }}
        continue-on-error: true
        shell: bash
        env:
          JFROG_USERNAME: ${{ secrets.JFROG_USERNAME }}
          JFROG_TOKEN:    ${{ secrets.JFROG_TOKEN }}
          SIGNUM_AGENT_IMAGE: ${{ steps.img.outputs.image }}
        run: |
          set -euo pipefail
          echo "=== Diagnostic: curl v2 HEAD ==="
          curl -sS -u "${JFROG_USERNAME}:${JFROG_TOKEN}" -I https://${{ env.SIGNUM_REGISTRY }}/v2/ || true
          echo "=== Diagnostic: docker login (password-stdin) ==="
          printf '%s' "${JFROG_TOKEN}" | docker login "${{ env.SIGNUM_REGISTRY }}" --username "${JFROG_USERNAME}" --password-stdin || true
          echo "=== diagnostic done ==="

      - name: Ensure image present (try authenticated pull if needed)
        id: ensure_image
        shell: bash
        env:
          SIGNUM_AGENT_IMAGE: ${{ steps.img.outputs.image }}
        run: |
          set -euo pipefail
          # If anonymous pull succeeded earlier we don't need to pull again.
          if [ "${{ steps.anon_pull.outputs.PULLED }}" = "anonymous" ]; then
            echo "Image already pulled anonymously."
            exit 0
          fi

          echo "Anonymous pull did not succeed; attempting authenticated pull (if login was run)."
          if docker pull "${SIGNUM_AGENT_IMAGE}"; then
            echo "Authenticated pull succeeded."
            exit 0
          else
            echo "Authenticated pull failed. Cannot obtain image ${SIGNUM_AGENT_IMAGE}."
            exit 1
          fi

      - name: Run Signum Agent container and list available certs (debug)
        shell: bash
        env:
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
          SIGNUM_AGENT_IMAGE: ${{ steps.img.outputs.image }}
        run: |
          set -euo pipefail

          echo "== Basic checks =="
          echo "Runner: $(uname -a)"
          echo "Docker: $(docker --version)"
          echo "SIGNUM_HOSTNAME set? $([[ -n "${SIGNUM_HOSTNAME:-}" ]] && echo yes || echo no)"
          echo "SIGNUM_CLIENTID set? $([[ -n "${SIGNUM_CLIENTID:-}" ]] && echo yes || echo no)"
          echo "SIGNUM_USERNAME set? $([[ -n "${SIGNUM_USERNAME:-}" ]] && echo yes || echo no)"
          echo "SIGNUM_PASSWORD set? $([[ -n "${SIGNUM_PASSWORD:-}" ]] && echo yes || echo no)"

          echo "== Image ref we will use (pull+run) =="
          echo "${SIGNUM_AGENT_IMAGE}"

          echo "== Ensure there is something to sign =="
          mkdir -p filestosign
          if [ ! -f "filestosign/example-script.ps1" ]; then
            echo 'Write-Host "Hello from Signum signing demo"' > filestosign/example-script.ps1
          fi

          echo "== Run container =="
          docker rm -f signum-agent >/dev/null 2>&1 || true

          docker run --name signum-agent -d \
            -v "$PWD/filestosign:/mnt/filestosign" \
            -e "SIGNUM_HOSTNAME=${SIGNUM_HOSTNAME}" \
            -e "SIGNUM_CLIENTID=${SIGNUM_CLIENTID:-}" \
            -e "SIGNUM_USERNAME=${SIGNUM_USERNAME}" \
            -e "SIGNUM_PASSWORD=${SIGNUM_PASSWORD}" \
            -e "SIGNUM_LOGLEVEL=HIGH" \
            -e "SIGNUM_LOGTYPE=FILE" \
            "${SIGNUM_AGENT_IMAGE}"

          echo "== Container status =="
          docker ps -a | sed -n '1,15p'

          echo "== List certs (signum-util lc) =="
          docker exec signum-agent signum-util lc | tee signum-certs.txt || true

          echo "### Signum cert listing (signum-util lc)" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          if [ -f signum-certs.txt ]; then
            cat signum-certs.txt >> "$GITHUB_STEP_SUMMARY"
          else
            echo "(no signum-certs.txt produced)" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Cleanup container
        if: always()
        shell: bash
        run: |
          docker rm -f signum-agent >/dev/null 2>&1 || true

      - name: Upload output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signum-output
          path: |
            signum-certs.txt
            filestosign/example-script.ps1
