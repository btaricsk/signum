name: Sign document with Signum Container Agent (pkcs11)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "filestosign/**"

permissions:
  contents: read

jobs:
  discover-cert:
    runs-on: ubuntu-latest
    env:
      SIGNUM_AGENT_IMAGE: keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1
      # Target cert identity
      TARGET_SERIAL: "2500008C4781F03B6AB4CED422000000008C47"
      TARGET_THUMBPRINT: "1405C03B01A76072AC8E6D676957AE42B368289A"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker login (keyfactor.jfrog.io)
        uses: docker/login-action@v3
        with:
          registry: keyfactor.jfrog.io
          username: ${{ secrets.JFROG_USERNAME }}
          password: ${{ secrets.JFROG_TOKEN }}
          logout: true

      - name: Ensure there is something to sign
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p filestosign
          if [ ! -f "filestosign/example-script.ps1" ]; then
            echo 'Write-Host "Hello from Signum signing demo"' > filestosign/example-script.ps1
          fi

      - name: Run Signum Agent container
        shell: bash
        env:
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
        run: |
          set -euo pipefail
          docker pull "${SIGNUM_AGENT_IMAGE}"
          docker rm -f signum-agent >/dev/null 2>&1 || true
          docker run --name signum-agent -d \
            -e "SIGNUM_HOSTNAME=$SIGNUM_HOSTNAME" \
            -e "SIGNUM_CLIENTID=$SIGNUM_CLIENTID" \
            -e "SIGNUM_USERNAME=$SIGNUM_USERNAME" \
            -e "SIGNUM_PASSWORD=$SIGNUM_PASSWORD" \
            -e "SIGNUM_LOGLEVEL=HIGH" \
            -e "SIGNUM_LOGTYPE=FILE" \
            "${SIGNUM_AGENT_IMAGE}"
          docker ps -a | sed -n '1,10p'

      - name: Install OpenSC tools (pkcs11-tool)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y opensc

      - name: Locate PKCS11 module in container (best effort)
        shell: bash
        run: |
          set -euo pipefail
          # The image log suggests OpenSC exists at /opt/opensc/bin. The PKCS11 module is usually a .so.
          # We'll search for likely pkcs11 modules inside the container and copy them out.
          docker exec signum-agent sh -lc 'find / -maxdepth 6 -type f \( -name "*pkcs11*.so" -o -name "opensc-pkcs11.so" \) 2>/dev/null | sed -n "1,200p"' | tee pkcs11-modules.txt
          MOD="$(head -n 1 pkcs11-modules.txt || true)"
          if [ -z "$MOD" ]; then
            echo "No pkcs11 module found in container via search. You likely need the Signum PKCS11 driver installed on runner."
            exit 1
          fi
          echo "Using module: $MOD"
          docker cp "signum-agent:$MOD" ./signum-pkcs11.so
          ls -la ./signum-pkcs11.so

      - name: Enumerate tokens and certificates (PKCS11)
        shell: bash
        run: |
          set -euo pipefail
          MODULE="$PWD/signum-pkcs11.so"

          echo "== pkcs11-tool --list-slots =="
          pkcs11-tool --module "$MODULE" --list-slots | tee pkcs11-slots.txt

          echo "== pkcs11-tool --list-objects (certs) =="
          # We don't pass PIN here yet. Some modules allow cert listing without it.
          pkcs11-tool --module "$MODULE" --list-objects --type cert 2>&1 | tee pkcs11-certs.txt || true

          echo "== Try with PIN if required =="
          if grep -qiE 'PIN|CKR_PIN|login' pkcs11-certs.txt; then
            pkcs11-tool --module "$MODULE" --login --pin "${{ secrets.SIGNUM_PKCS11_PIN }}" --list-objects --type cert 2>&1 | tee pkcs11-certs-with-pin.txt
          fi

      - name: Find target cert by serial or thumbprint
        shell: bash
        run: |
          set -euo pipefail

          # Combine outputs
          cat pkcs11-certs.txt pkcs11-certs-with-pin.txt 2>/dev/null > pkcs11-certs-all.txt || true

          # Try to match serial directly
          if grep -q "${TARGET_SERIAL}" pkcs11-certs-all.txt; then
            echo "Found serial in PKCS11 output."
          else
            echo "Did not see the serial in raw listing output. Next step will be to extract cert(s) and compute fingerprints."
          fi

          # Export all cert objects and compute SHA1 thumbprints (most Authenticode thumbprints are SHA1)
          mkdir -p exported-certs
          idx=0
          # Extract object IDs from pkcs11-tool output if present (commonly "ID: xx" lines)
          IDS=$(awk '/^  ID:/{print $2}' pkcs11-certs-all.txt | sort -u)
          if [ -z "$IDS" ]; then
            echo "No object IDs detected in output; cannot auto-export certs. See pkcs11-certs-all.txt for format."
            exit 1
          fi

          for id in $IDS; do
            idx=$((idx+1))
            out="exported-certs/cert-${idx}.der"
            echo "Exporting cert with id=$id -> $out"
            pkcs11-tool --module "$PWD/signum-pkcs11.so" --read-object --type cert --id "$id" --output-file "$out" 2>/dev/null || true
          done

          echo "== Compute thumbprints =="
          : > cert-matches.txt
          for f in exported-certs/*.der; do
            [ -f "$f" ] || continue
            sha1="$(openssl x509 -inform der -in "$f" -noout -fingerprint -sha1 | cut -d= -f2 | tr -d :)"
            serial="$(openssl x509 -inform der -in "$f" -noout -serial | cut -d= -f2 | tr '[:lower:]' '[:upper:]')"
            echo "$f serial=$serial thumbprint=$sha1" | tee -a cert-matches.txt
          done

          echo "== Select target cert =="
          match_line="$(grep -i "${TARGET_THUMBPRINT}" cert-matches.txt | head -n 1 || true)"
          if [ -z "$match_line" ]; then
            echo "Target thumbprint not found in exported certs."
            exit 1
          fi

          echo "$match_line" | tee selected-cert.txt
          echo "### Selected cert" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat selected-cert.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Cleanup container
        if: always()
        shell: bash
        run: |
          docker rm -f signum-agent >/dev/null 2>&1 || true

      - name: Upload discovery output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signum-pkcs11-discovery
          path: |
            pkcs11-modules.txt
            pkcs11-slots.txt
            pkcs11-certs.txt
            pkcs11-certs-with-pin.txt
            pkcs11-certs-all.txt
            exported-certs/
            cert-matches.txt
            selected-cert.txt
            filestosign/example-script.ps1
