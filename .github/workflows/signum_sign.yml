name: Signum PKCS11 cert discovery (by thumbprint)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "filestosign/**"

permissions:
  contents: read

jobs:
  pkcs11-discovery:
    runs-on: ubuntu-latest
    env:
      SIGNUM_REGISTRY: keyfactor.jfrog.io
      SIGNUM_AGENT_IMAGE: keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1

      TARGET_SERIAL: "2500008C4781F03B6AB4CED422000000008C47"
      TARGET_THUMBPRINT: "1405C03B01A76072AC8E6D676957AE42B368289A"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker login (keyfactor.jfrog.io)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.SIGNUM_REGISTRY }}
          username: ${{ secrets.JFROG_USERNAME }}
          password: ${{ secrets.JFROG_TOKEN }}
          logout: true

      - name: Ensure there is something to sign
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p filestosign
          if [ ! -f "filestosign/example-script.ps1" ]; then
            echo 'Write-Host "Hello from Signum signing demo"' > filestosign/example-script.ps1
          fi

      - name: Start Signum Agent container
        shell: bash
        env:
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
        run: |
          set -euo pipefail
          docker pull "${SIGNUM_AGENT_IMAGE}"
          docker rm -f signum-agent >/dev/null 2>&1 || true
          docker run --name signum-agent -d \
            -e "SIGNUM_HOSTNAME=$SIGNUM_HOSTNAME" \
            -e "SIGNUM_CLIENTID=$SIGNUM_CLIENTID" \
            -e "SIGNUM_USERNAME=$SIGNUM_USERNAME" \
            -e "SIGNUM_PASSWORD=$SIGNUM_PASSWORD" \
            -e "SIGNUM_LOGLEVEL=HIGH" \
            -e "SIGNUM_LOGTYPE=FILE" \
            "${SIGNUM_AGENT_IMAGE}"
          docker ps -a | sed -n '1,15p'
          docker logs signum-agent | tail -n 80 | tee signum-agent-startup.log || true

      - name: Install tools (OpenSC + OpenSSL)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y opensc openssl

      - name: Materialize Signum PKCS11 module
        shell: bash
        env:
          SIGNUM_PKCS11_MODULE_B64: ${{ secrets.SIGNUM_PKCS11_MODULE_B64 }}
        run: |
          set -euo pipefail
          if [ -z "${SIGNUM_PKCS11_MODULE_B64:-}" ]; then
            echo "Missing secret SIGNUM_PKCS11_MODULE_B64 (base64 of the PKCS11 .so)."
            exit 1
          fi

          mkdir -p pkcs11
          echo "$SIGNUM_PKCS11_MODULE_B64" | base64 -d > pkcs11/signum-pkcs11.so
          chmod 755 pkcs11/signum-pkcs11.so
          file pkcs11/signum-pkcs11.so | tee pkcs11-module-file.txt
          ls -la pkcs11/signum-pkcs11.so

      - name: PKCS11 list slots and cert objects
        shell: bash
        env:
          SIGNUM_PKCS11_PIN: ${{ secrets.SIGNUM_PKCS11_PIN }}
        run: |
          set -euo pipefail
          MODULE="$PWD/pkcs11/signum-pkcs11.so"

          echo "== pkcs11-tool --list-slots =="
          pkcs11-tool --module "$MODULE" --list-slots | tee pkcs11-slots.txt

          echo "== pkcs11-tool --list-objects (certs, no login) =="
          pkcs11-tool --module "$MODULE" --list-objects --type cert 2>&1 | tee pkcs11-certs.txt || true

          echo "== pkcs11-tool --list-objects (certs, with login if PIN provided) =="
          if [ -n "${SIGNUM_PKCS11_PIN:-}" ]; then
            pkcs11-tool --module "$MODULE" --login --pin "$SIGNUM_PKCS11_PIN" --list-objects --type cert 2>&1 | tee pkcs11-certs-with-pin.txt || true
          else
            echo "No SIGNUM_PKCS11_PIN provided; skipping login listing." | tee pkcs11-certs-with-pin.txt
          fi

      - name: Export certs and match thumbprint
        shell: bash
        env:
          SIGNUM_PKCS11_PIN: ${{ secrets.SIGNUM_PKCS11_PIN }}
        run: |
          set -euo pipefail
          MODULE="$PWD/pkcs11/signum-pkcs11.so"

          cat pkcs11-certs.txt pkcs11-certs-with-pin.txt 2>/dev/null > pkcs11-certs-all.txt || true

          echo "== Extract candidate IDs from pkcs11 output =="
          # pkcs11-tool often prints "ID: <hex>" under objects.
          IDS="$(awk '/^[[:space:]]*ID:/{print $2}' pkcs11-certs-all.txt | sort -u | tr -d '\r')"
          echo "$IDS" | tee pkcs11-object-ids.txt

          if [ -z "${IDS}" ]; then
            echo "No object IDs found in pkcs11 listing output. The module may hide IDs or requires different flags."
            echo "Inspect pkcs11-certs-all.txt artifact."
            exit 1
          fi

          mkdir -p exported-certs
          i=0
          for id in $IDS; do
            i=$((i+1))
            out="exported-certs/cert-${i}.der"
            echo "Exporting cert id=$id -> $out"
            if [ -n "${SIGNUM_PKCS11_PIN:-}" ]; then
              pkcs11-tool --module "$MODULE" --login --pin "$SIGNUM_PKCS11_PIN" \
                --read-object --type cert --id "$id" --output-file "$out" 2>/dev/null || true
            else
              pkcs11-tool --module "$MODULE" \
                --read-object --type cert --id "$id" --output-file "$out" 2>/dev/null || true
            fi
          done

          echo "== Compute serial and SHA1 thumbprints for exported certs =="
          : > cert-matches.txt
          for f in exported-certs/*.der; do
            [ -s "$f" ] || continue
            serial="$(openssl x509 -inform der -in "$f" -noout -serial | cut -d= -f2 | tr '[:lower:]' '[:upper:]')"
            thumb="$(openssl x509 -inform der -in "$f" -noout -fingerprint -sha1 | cut -d= -f2 | tr -d : | tr '[:lower:]' '[:upper:]')"
            echo "$f serial=$serial thumbprint=$thumb" | tee -a cert-matches.txt
          done

          echo "== Select target cert =="
          grep -i "${TARGET_THUMBPRINT}" cert-matches.txt | head -n 1 | tee selected-cert.txt
          if [ ! -s selected-cert.txt ]; then
            echo "Target thumbprint not found. Check cert-matches.txt."
            exit 1
          fi

          echo "### Selected certificate" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat selected-cert.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Cleanup container
        if: always()
        shell: bash
        run: |
          docker rm -f signum-agent >/dev/null 2>&1 || true

      - name: Upload outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signum-pkcs11-discovery
          path: |
            pkcs11-module-file.txt
            pkcs11/signum-pkcs11.so
            pkcs11-slots.txt
            pkcs11-certs.txt
            pkcs11-certs-with-pin.txt
            pkcs11-certs-all.txt
            pkcs11-object-ids.txt
            exported-certs/
            cert-matches.txt
            selected-cert.txt
            signum-agent-startup.log
            filestosign/example-script.ps1
