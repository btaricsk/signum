name: Sign document with Signum Container Agent (basic)

on:
  workflow_dispatch:
    inputs:
      signum_agent_image:
        description: "Container image to use (include tag)."
        required: false
        default: "keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1"
  push:
    branches: ["main"]
    paths:
      - "filestosign/**"

permissions:
  contents: read

jobs:
  sign:
    runs-on: ubuntu-latest
    env:
      SIGNUM_REGISTRY: keyfactor.jfrog.io
      DEFAULT_SIGNUM_AGENT_IMAGE: keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Notes / Support Disclaimer
        shell: bash
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<'EOF'
          ## Signum Container Agent â€“ Support / Usage Notes
          Support issues: https://support.keyfactor.com/
          EOF

      # Required repo secrets:
      # - JFROG_USERNAME
      # - JFROG_TOKEN (API token or password)
      - name: Docker login (keyfactor.jfrog.io)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.SIGNUM_REGISTRY }}
          username: ${{ secrets.JFROG_USERNAME }}
          password: ${{ secrets.JFROG_TOKEN }}
          logout: true

      - name: Resolve agent image ref
        id: img
        shell: bash
        run: |
          set -euo pipefail
          IMG="${{ inputs.signum_agent_image }}"
          if [ -z "${IMG}" ]; then
            IMG="${DEFAULT_SIGNUM_AGENT_IMAGE}"
          fi
          echo "image=${IMG}" >> "$GITHUB_OUTPUT"
          echo "Using agent image: ${IMG}"

      - name: Run Signum Agent container and list available certs (robust)
        shell: bash
        env:
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
          SIGNUM_AGENT_IMAGE: ${{ steps.img.outputs.image }}
        run: |
          set -euo pipefail

          echo "== Basic checks =="
          echo "Runner: $(uname -a)"
          echo "Docker: $(docker --version)"
          echo "SIGNUM_HOSTNAME set? $([[ -n "${SIGNUM_HOSTNAME:-}" ]] && echo yes || echo no)"
          echo "SIGNUM_CLIENTID set? $([[ -n "${SIGNUM_CLIENTID:-}" ]] && echo yes || echo no)"
          echo "SIGNUM_USERNAME set? $([[ -n "${SIGNUM_USERNAME:-}" ]] && echo yes || echo no)"
          echo "SIGNUM_PASSWORD set? $([[ -n "${SIGNUM_PASSWORD:-}" ]] && echo yes || echo no)"
          echo "== Image ref we will use (pull+run) =="
          echo "${SIGNUM_AGENT_IMAGE}"

          echo "== Ensure there is something to sign =="
          mkdir -p filestosign
          if [ ! -f "filestosign/example-script.ps1" ]; then
            echo 'Write-Host "Hello from Signum signing demo"' > filestosign/example-script.ps1
          fi

          echo "== Pull Signum agent image =="
          docker pull "${SIGNUM_AGENT_IMAGE}"

          echo "== Run container =="
          docker rm -f signum-agent >/dev/null 2>&1 || true
          docker run --name signum-agent -d \
            -v "$PWD/filestosign:/mnt/filestosign" \
            -e "SIGNUM_HOSTNAME=$SIGNUM_HOSTNAME" \
            -e "SIGNUM_CLIENTID=$SIGNUM_CLIENTID" \
            -e "SIGNUM_USERNAME=$SIGNUM_USERNAME" \
            -e "SIGNUM_PASSWORD=$SIGNUM_PASSWORD" \
            -e "SIGNUM_LOGLEVEL=HIGH" \
            -e "SIGNUM_LOGTYPE=FILE" \
            "${SIGNUM_AGENT_IMAGE}"

          echo "== Container status =="
          docker ps -a | sed -n '1,15p'

          echo "== Debug: PATH and root listing =="
          docker exec signum-agent sh -lc '
            echo "PATH=$PATH"
            id || true
            whoami || true
            uname -a || true
            ls -la / || true
          ' | tee signum-container-debug.txt

          echo "== Inspect Keyfactor directories for CLI =="
          docker exec signum-agent sh -lc '
            set -e
            for d in \
              /usr/local/keyfactor/bin \
              /usr/local/keyfactor/service \
              /usr/local/keyfactor/setup \
              /opt/keyfactor/jo/bin \
              /etc/keyfactor/user/.dotnet/tools
            do
              if [ -d "$d" ]; then
                echo "--- $d ---"
                ls -la "$d" | sed -n "1,200p"
              fi
            done
          ' | tee -a signum-container-debug.txt

          echo "== Find executables with signum in the name (Keyfactor paths) =="
          docker exec signum-agent sh -lc '
            set -e
            for base in /usr/local/keyfactor /opt/keyfactor /etc/keyfactor; do
              [ -d "$base" ] || continue
              find "$base" -maxdepth 5 -type f -name "*signum*" -perm -111 2>/dev/null
            done
          ' | tee signum-signum-binaries.txt || true

          echo "== Attempt cert listing (best effort) =="
          set +e
          docker exec signum-agent sh -lc '
            set -e
            try() { echo "+ $*"; "$@"; }

            # Try most likely locations/names first.
            CANDIDATES="
              /usr/local/keyfactor/bin/signum-util
              /usr/local/keyfactor/bin/signum
              /usr/local/keyfactor/bin/signumutil
              /usr/local/keyfactor/bin/kf-signum
              /opt/keyfactor/jo/bin/signum
              /opt/keyfactor/jo/bin/signum-util
              /etc/keyfactor/user/.dotnet/tools/signum-util
            "

            for c in $CANDIDATES; do
              if [ -x "$c" ]; then
                try "$c" lc || true
                try "$c" list-certs || true
                try "$c" --help || true
                exit 0
              fi
            done

            # Fall back: try discovered binaries (up to 20).
            for c in $(find /usr/local/keyfactor /opt/keyfactor /etc/keyfactor -maxdepth 5 -type f -name "*signum*" -perm -111 2>/dev/null | head -n 20); do
              try "$c" lc || true
              try "$c" list-certs || true
              try "$c" --help || true
            done

            echo "No cert listing command succeeded."
            exit 42
          ' | tee signum-certs.txt
          CERT_RC=${PIPESTATUS[0]}
          set -e

          echo "== Agent logs (tail) =="
          docker logs signum-agent | tail -n 400 | tee signum-agent.log || true

          echo "### Signum outputs" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Image:** \`${SIGNUM_AGENT_IMAGE}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "**Cert listing exit code:** \`${CERT_RC}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "#### signum-certs.txt" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          sed -n '1,200p' signum-certs.txt >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "#### signum-signum-binaries.txt" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          sed -n '1,200p' signum-signum-binaries.txt >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "#### signum-agent.log (tail)" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          tail -n 200 signum-agent.log >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"

          # Fail after collecting artifacts if cert listing failed.
          if [ "${CERT_RC}" -ne 0 ]; then
            echo "Cert listing did not succeed (rc=${CERT_RC}). See artifacts."
            exit "${CERT_RC}"
          fi

      - name: Cleanup container
        if: always()
        shell: bash
        run: |
          docker rm -f signum-agent >/dev/null 2>&1 || true

      - name: Upload output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signum-output
          path: |
            signum-certs.txt
            signum-agent.log
            signum-container-debug.txt
            signum-signum-binaries.txt
            filestosign/example-script.ps1
