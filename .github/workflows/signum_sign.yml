name: Sign document with Signum Container Agent (basic)

on:
  workflow_dispatch:
    inputs:
      signum_agent_image:
        description: "Container image to use (include tag)."
        required: false
        default: "keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1"
  push:
    branches: ["main"]
    paths:
      - "filestosign/**"
      - "pkcs11/**"

permissions:
  contents: read

jobs:
  sign:
    runs-on: ubuntu-latest
    env:
      SIGNUM_REGISTRY: keyfactor.jfrog.io
      DEFAULT_SIGNUM_AGENT_IMAGE: keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1
      PKCS11_REPO_MODULE: pkcs11/signum-pkcs11.so
      PKCS11_MOUNT_PATH: /pkcs11/signum-pkcs11.so

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Notes / Support Disclaimer
        shell: bash
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<'EOF'
          ## Signum Container Agent â€“ Support / Usage Notes
          Support issues: https://support.keyfactor.com/
          EOF

      - name: Docker login (keyfactor.jfrog.io)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.SIGNUM_REGISTRY }}
          username: ${{ secrets.JFROG_USERNAME }}
          password: ${{ secrets.JFROG_TOKEN }}
          logout: true

      - name: Resolve agent image ref
        id: img
        shell: bash
        run: |
          set -euo pipefail
          IMG="${{ inputs.signum_agent_image }}"
          if [ -z "${IMG}" ]; then
            IMG="${DEFAULT_SIGNUM_AGENT_IMAGE}"
          fi
          echo "image=${IMG}" >> "$GITHUB_OUTPUT"
          echo "Using agent image: ${IMG}"

      - name: Run Signum Agent container and attempt cert discovery via API and PKCS11 slots
        shell: bash
        env:
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
          SIGNUM_AGENT_IMAGE: ${{ steps.img.outputs.image }}
          SIGNUM_PKCS11_PIN: ${{ secrets.SIGNUM_PKCS11_PIN }}
        run: |
          set -euo pipefail

          echo "== Basic checks =="
          echo "Runner: $(uname -a)"
          echo "Docker: $(docker --version)"
          echo "SIGNUM_HOSTNAME set? $([[ -n "${SIGNUM_HOSTNAME:-}" ]] && echo yes || echo no)"
          echo "SIGNUM_CLIENTID set? $([[ -n "${SIGNUM_CLIENTID:-}" ]] && echo yes || echo no)"
          echo "SIGNUM_USERNAME set? $([[ -n "${SIGNUM_USERNAME:-}" ]] && echo yes || echo no)"
          echo "SIGNUM_PASSWORD set? $([[ -n "${SIGNUM_PASSWORD:-}" ]] && echo yes || echo no)"
          echo "== Image ref we will use (pull+run) =="
          echo "${SIGNUM_AGENT_IMAGE}"

          echo "== Ensure there is something to sign =="
          mkdir -p filestosign
          if [ ! -f "filestosign/example-script.ps1" ]; then
            echo 'Write-Host "Hello from Signum signing demo"' > filestosign/example-script.ps1
          fi

          echo "== Pull Signum agent image =="
          docker pull "${SIGNUM_AGENT_IMAGE}"

          echo "== Run container (publish common API ports) =="
          docker rm -f signum-agent >/dev/null 2>&1 || true
          docker run --name signum-agent -d \
            -p 8080:8080 \
            -p 5000:5000 \
            -p 7000:7000 \
            -v "$PWD/filestosign:/mnt/filestosign" \
            -e "SIGNUM_HOSTNAME=$SIGNUM_HOSTNAME" \
            -e "SIGNUM_CLIENTID=$SIGNUM_CLIENTID" \
            -e "SIGNUM_USERNAME=$SIGNUM_USERNAME" \
            -e "SIGNUM_PASSWORD=$SIGNUM_PASSWORD" \
            -e "SIGNUM_LOGLEVEL=HIGH" \
            -e "SIGNUM_LOGTYPE=FILE" \
            "${SIGNUM_AGENT_IMAGE}"

          echo "== Container status =="
          docker ps -a | sed -n '1,20p'
          docker port signum-agent | tee signum-container-ports.txt || true

          echo "== Wait briefly for service startup =="
          sleep 3

          echo "== Probe agent HTTP endpoints (best effort) =="
          : > signum-api-probe.txt
          for port in 8080 5000 7000; do
            for path in /swagger /swagger/index.html /health /healthz /api/health /api/status /; do
              url="http://127.0.0.1:${port}${path}"
              code="$(curl -s -o /dev/null -w '%{http_code}' "$url" || true)"
              echo "${code} ${url}" | tee -a signum-api-probe.txt
            done
          done

          echo "== Attempt cert listing via likely API routes (best effort) =="
          : > signum-certs.txt
          set +e
          for port in 8080 5000 7000; do
            for path in \
              /api/certificates \
              /api/certs \
              /api/v1/certificates \
              /api/v1/certs \
              /certificates \
              /certs \
              /swagger/v1/swagger.json
            do
              url="http://127.0.0.1:${port}${path}"
              echo "== GET ${url} ==" | tee -a signum-certs.txt
              curl -sS "$url" | head -c 20000 | tee -a signum-certs.txt
              echo "" >> signum-certs.txt
            done
          done
          set -e

          echo "== PKCS11 slot listing using OpenSC helper container =="
          : > pkcs11-slots.txt

          if [ ! -f "${PKCS11_REPO_MODULE}" ]; then
            echo "Missing PKCS11 module in repo at ${PKCS11_REPO_MODULE}" | tee -a pkcs11-slots.txt
            echo "Commit the Signum PKCS11 module to pkcs11/signum-pkcs11.so to enable slot listing" | tee -a pkcs11-slots.txt
          else
            echo "Using PKCS11 module from repo ${PKCS11_REPO_MODULE}" | tee -a pkcs11-slots.txt

            docker run --rm \
              -v "$PWD/${PKCS11_REPO_MODULE}:${PKCS11_MOUNT_PATH}:ro" \
              ghcr.io/open-sc/opensc:latest \
              pkcs11-tool --module "${PKCS11_MOUNT_PATH}" --list-slots 2>&1 | tee -a pkcs11-slots.txt || true

            echo "" | tee -a pkcs11-slots.txt
            echo "== PKCS11 cert objects no login ==" | tee -a pkcs11-slots.txt
            docker run --rm \
              -v "$PWD/${PKCS11_REPO_MODULE}:${PKCS11_MOUNT_PATH}:ro" \
              ghcr.io/open-sc/opensc:latest \
              pkcs11-tool --module "${PKCS11_MOUNT_PATH}" --list-objects --type cert 2>&1 | tee -a pkcs11-slots.txt || true

            if [ -n "${SIGNUM_PKCS11_PIN:-}" ]; then
              echo "" | tee -a pkcs11-slots.txt
              echo "== PKCS11 cert objects with login ==" | tee -a pkcs11-slots.txt
              docker run --rm \
                -v "$PWD/${PKCS11_REPO_MODULE}:${PKCS11_MOUNT_PATH}:ro" \
                ghcr.io/open-sc/opensc:latest \
                pkcs11-tool --module "${PKCS11_MOUNT_PATH}" --login --pin "${SIGNUM_PKCS11_PIN}" --list-objects --type cert 2>&1 | tee -a pkcs11-slots.txt || true
            else
              echo "" | tee -a pkcs11-slots.txt
              echo "SIGNUM_PKCS11_PIN not set skipping logged in listing" | tee -a pkcs11-slots.txt
            fi
          fi

          echo "== Agent logs (tail) =="
          docker logs signum-agent | tail -n 500 | tee signum-agent.log || true

          echo "### Signum outputs" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Image:** \`${SIGNUM_AGENT_IMAGE}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "#### API probe" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          sed -n '1,200p' signum-api-probe.txt >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "#### Cert listing attempt (truncated)" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          sed -n '1,200p' signum-certs.txt >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "#### PKCS11 slot listing (truncated)" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          sed -n '1,200p' pkcs11-slots.txt >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "
