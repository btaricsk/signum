name: Download latest Signum linux agent (resolve real file via storage API)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "filestosign/**"

permissions:
  contents: read

jobs:
  sign:
    runs-on: ubuntu-latest
    env:
      JFROG_BASE_URL: https://keyfactor.jfrog.io/artifactory
      JFROG_REPO: signum-bdewberry-testing
      AGENT_PARENT_PATH: keyfactor/signum-linux-agent

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Notes / Support Disclaimer
        shell: bash
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<'EOF'
          ## Signum Agent â€“ Support / Usage Notes
          Support issues: https://support.keyfactor.com/
          EOF

      - name: Validate JFrog credentials present
        shell: bash
        env:
          JFROG_USERNAME: ${{ secrets.JFROG_USERNAME }}
          JFROG_TOKEN: ${{ secrets.JFROG_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${JFROG_USERNAME:-}" ] || [ -z "${JFROG_TOKEN:-}" ]; then
            echo "Missing secrets. Add JFROG_USERNAME and JFROG_TOKEN."
            exit 1
          fi
          echo "JFrog credentials present."

      - name: Download latest Signum linux agent (resolve real file via storage API)
        shell: bash
        env:
          JFROG_USERNAME: ${{ secrets.JFROG_USERNAME }}
          JFROG_TOKEN: ${{ secrets.JFROG_TOKEN }}
        run: |
          set -euo pipefail

          mkdir -p signum-agent-download

          FILE_PATH="$(python3 - <<'PY'
          import base64, json, os, sys, urllib.request, urllib.error

          base = os.environ["JFROG_BASE_URL"].rstrip("/")
          repo = os.environ["JFROG_REPO"]
          parent = os.environ["AGENT_PARENT_PATH"].strip("/")
          user = os.environ["JFROG_USERNAME"]
          token = os.environ["JFROG_TOKEN"]

          def get_json(url: str) -> dict:
            req = urllib.request.Request(url)
            auth = base64.b64encode(f"{user}:{token}".encode()).decode()
            req.add_header("Authorization", f"Basic {auth}")
            req.add_header("Accept", "application/json")
            with urllib.request.urlopen(req) as resp:
              return json.loads(resp.read().decode())

          def children(path: str):
            url = f"{base}/api/storage/{repo}/{path}"
            j = get_json(url)
            return [c["uri"].lstrip("/") for c in j.get("children", [])]

          def looks_like_file(name: str) -> bool:
            return "." in name.split("/")[-1]

          kids = children(parent)
          if not kids:
            print(f"No children under {parent}", file=sys.stderr)
            sys.exit(1)

          chosen = f"{parent}/latest" if "latest" in kids else f"{parent}/" + sorted(kids)[-1]

          def resolve_to_file(path: str) -> str:
            try:
              kids2 = children(path)
            except urllib.error.HTTPError:
              return path

            if kids2:
              files = [k for k in kids2 if looks_like_file(k)]
              if files:
                return path.rstrip("/") + "/" + sorted(files)[0]
              return resolve_to_file(path.rstrip("/") + "/" + sorted(kids2)[0])
            return path

          print(resolve_to_file(chosen))
          PY
          )"

          echo "Resolved file path: ${FILE_PATH}"

          FILE_URL="${JFROG_BASE_URL}/${JFROG_REPO}/${FILE_PATH}"
          OUT="signum-agent-download/$(basename "${FILE_PATH}")"

          echo "Downloading from:"
          echo "${FILE_URL}"

          curl -fLsS -u "${JFROG_USERNAME}:${JFROG_TOKEN}" -o "${OUT}" "${FILE_URL}"

          echo "== Downloaded file info =="
          ls -lah signum-agent-download
          file "${OUT}" || true

          if file "${OUT}" | grep -qiE 'zip archive'; then
            unzip -o "${OUT}" -d signum-agent-download
          elif file "${OUT}" | grep -qiE 'gzip compressed|tar archive'; then
            tar -xf "${OUT}" -C signum-agent-download || tar -xzf "${OUT}" -C signum-agent-download
          fi

          echo "### Downloaded Signum agent artifact" >> "$GITHUB_STEP_SUMMARY"
          echo "- Source: ${FILE_URL}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Output: ${OUT}" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload downloaded artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signum-agent-generic-download
          path: |
            signum-agent-download/**
