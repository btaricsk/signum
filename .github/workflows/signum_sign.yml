name: Signum PKCS11 discovery list certs

on:
  workflow_dispatch:
    inputs:
      signum_agent_image:
        description: "Agent container image to run include tag"
        required: false
        default: "keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1"
      pkcs11_module_path:
        description: "Path to PKCS11 so in repo default pkcs11 signum pkcs11 so"
        required: false
        default: "pkcs11/signum-pkcs11.so"
  push:
    branches: ["main"]
    paths:
      - "filestosign/**"
      - "pkcs11/**"

permissions:
  contents: read

jobs:
  pkcs11-discovery:
    runs-on: ubuntu-latest
    env:
      DEFAULT_SIGNUM_AGENT_IMAGE: keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create run info
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "date_utc=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "runner=$(uname -a)"
            echo "pwd=$(pwd)"
            echo "repo=$GITHUB_REPOSITORY"
            echo "sha=$GITHUB_SHA"
          } > run-info.txt

      - name: Resolve agent image and module path
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          IMG="${{ github.event.inputs.signum_agent_image }}"
          if [ -z "${IMG}" ]; then
            IMG="${DEFAULT_SIGNUM_AGENT_IMAGE}"
          fi

          MODPATH="${{ github.event.inputs.pkcs11_module_path }}"
          if [ -z "${MODPATH}" ]; then
            MODPATH="pkcs11/signum-pkcs11.so"
          fi

          echo "image=${IMG}" >> "$GITHUB_OUTPUT"
          echo "module_path=${MODPATH}" >> "$GITHUB_OUTPUT"

          echo "Using agent image: ${IMG}"
          echo "Using module path: ${MODPATH}"

      - name: Install PKCS11 tooling
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y opensc openssl

      - name: Start Signum Agent container
        shell: bash
        env:
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
          SIGNUM_AGENT_IMAGE: ${{ steps.vars.outputs.image }}
        run: |
          set -euo pipefail

          echo "== Basic checks ==" | tee basic-checks.txt
          echo "Runner: $(uname -a)" | tee -a basic-checks.txt
          echo "Docker: $(docker --version)" | tee -a basic-checks.txt
          echo "SIGNUM_HOSTNAME set? $([[ -n "${SIGNUM_HOSTNAME:-}" ]] && echo yes || echo no)" | tee -a basic-checks.txt
          echo "SIGNUM_CLIENTID set? $([[ -n "${SIGNUM_CLIENTID:-}" ]] && echo yes || echo no)" | tee -a basic-checks.txt
          echo "SIGNUM_USERNAME set? $([[ -n "${SIGNUM_USERNAME:-}" ]] && echo yes || echo no)" | tee -a basic-checks.txt
          echo "SIGNUM_PASSWORD set? $([[ -n "${SIGNUM_PASSWORD:-}" ]] && echo yes || echo no)" | tee -a basic-checks.txt
          echo "Image: ${SIGNUM_AGENT_IMAGE}" | tee -a basic-checks.txt

          docker pull "${SIGNUM_AGENT_IMAGE}"
          docker rm -f signum-agent >/dev/null 2>&1 || true
          docker run --name signum-agent -d \
            -e "SIGNUM_HOSTNAME=$SIGNUM_HOSTNAME" \
            -e "SIGNUM_CLIENTID=$SIGNUM_CLIENTID" \
            -e "SIGNUM_USERNAME=$SIGNUM_USERNAME" \
            -e "SIGNUM_PASSWORD=$SIGNUM_PASSWORD" \
            -e "SIGNUM_LOGLEVEL=HIGH" \
            -e "SIGNUM_LOGTYPE=FILE" \
            "${SIGNUM_AGENT_IMAGE}"

          docker ps -a | sed -n '1,15p' | tee signum-container-status.txt
          docker logs signum-agent | tail -n 220 | tee signum-agent-startup.log || true

      - name: Locate PKCS11 module
        id: mod
        shell: bash
        env:
          REPO_MODULE_PATH: ${{ steps.vars.outputs.module_path }}
        run: |
          set -euo pipefail

          FOUND=""

          if [ -f "${REPO_MODULE_PATH}" ]; then
            FOUND="${REPO_MODULE_PATH}"
          else
            echo "Repo module not found at ${REPO_MODULE_PATH}" | tee pkcs11-module-missing.txt
          fi

          if [ -z "${FOUND}" ]; then
            docker exec signum-agent sh -lc 'find / -maxdepth 7 -type f \( -name "*pkcs11*.so" -o -name "opensc-pkcs11.so" \) 2>/dev/null | sed -n "1,200p"' | tee pkcs11-modules-in-container.txt || true
            CANDIDATE="$(head -n 1 pkcs11-modules-in-container.txt || true)"
            if [ -n "${CANDIDATE}" ]; then
              echo "Found candidate in container: ${CANDIDATE}" | tee pkcs11-module-found.txt
              docker cp "signum-agent:${CANDIDATE}" ./signum-pkcs11.so
              chmod 755 ./signum-pkcs11.so || true
              FOUND="$PWD/signum-pkcs11.so"
            fi
          fi

          if [ -z "${FOUND}" ]; then
            printf '%s\n' \
              "No PKCS11 module found" \
              "Expected repo path ${REPO_MODULE_PATH} or an agent image that includes the module" \
              "This agent image does not appear to contain a PKCS11 module" \
              > pkcs11-module-error.txt

            echo "### PKCS11 module not found" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            cat pkcs11-module-error.txt >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

          echo "module=${FOUND}" >> "$GITHUB_OUTPUT"
          file "${FOUND}" | tee pkcs11-module-file.txt
          ls -la "${FOUND}" | tee pkcs11-module-ls.txt

      - name: List all certificates via PKCS11
        shell: bash
        env:
          MODULE_PATH: ${{ steps.mod.outputs.module }}
          SIGNUM_PKCS11_PIN: ${{ secrets.SIGNUM_PKCS11_PIN }}
        run: |
          set -euo pipefail
          MODULE="${MODULE_PATH}"

          pkcs11-tool --module "$MODULE" --list-slots | tee pkcs11-slots.txt

          pkcs11-tool --module "$MODULE" --list-objects --type cert 2>&1 | tee pkcs11-certs.txt || true

          if [ -n "${SIGNUM_PKCS11_PIN:-}" ]; then
            pkcs11-tool --module "$MODULE" --login --pin "$SIGNUM_PKCS11_PIN" --list-objects --type cert 2>&1 | tee pkcs11-certs-with-pin.txt || true
          else
            echo "No SIGNUM_PKCS11_PIN provided skipping login listing" | tee pkcs11-certs-with-pin.txt
          fi

          cat pkcs11-certs.txt pkcs11-certs-with-pin.txt 2>/dev/null > pkcs11-certs-all.txt || true

          IDS="$(awk '/^[[:space:]]*ID:/{print $2}' pkcs11-certs-all.txt | sort -u | tr -d '\r')"
          echo "$IDS" | tee pkcs11-object-ids.txt

          if [ -z "${IDS}" ]; then
            echo "No object IDs found inspect pkcs11-certs-all.txt" | tee pkcs11-inventory-error.txt
            exit 1
          fi

          mkdir -p exported-certs
          i=0
          for id in $IDS; do
            i=$((i+1))
            out="exported-certs/cert-${i}.der"
            if [ -n "${SIGNUM_PKCS11_PIN:-}" ]; then
              pkcs11-tool --module "$MODULE" --login --pin "$SIGNUM_PKCS11_PIN" \
                --read-object --type cert --id "$id" --output-file "$out" 2>/dev/null || true
            else
              pkcs11-tool --module "$MODULE" \
                --read-object --type cert --id "$id" --output-file "$out" 2>/dev/null || true
            fi
          done

          : > cert-inventory.txt
          for f in exported-certs/*.der; do
            [ -s "$f" ] || continue
            serial="$(openssl x509 -inform der -in "$f" -noout -serial | cut -d= -f2 | tr '[:lower:]' '[:upper:]')"
            thumb="$(openssl x509 -inform der -in "$f" -noout -fingerprint -sha1 | cut -d= -f2 | tr -d : | tr '[:lower:]' '[:upper:]')"
            subj="$(openssl x509 -inform der -in "$f" -noout -subject | sed 's/^subject=//')"
            issr="$(openssl x509 -inform der -in "$f" -noout -issuer  | sed 's/^issuer=//')"
            nb="$(openssl x509 -inform der -in "$f" -noout -startdate | cut -d= -f2)"
            na="$(openssl x509 -inform der -in "$f" -noout -enddate   | cut -d= -f2)"
            echo "$f" >> cert-inventory.txt
            echo "  serial:      $serial" >> cert-inventory.txt
            echo "  thumbprint:  $thumb" >> cert-inventory.txt
            echo "  notBefore:   $nb" >> cert-inventory.txt
            echo "  notAfter:    $na" >> cert-inventory.txt
            echo "  subject:     $subj" >> cert-inventory.txt
            echo "  issuer:      $issr" >> cert-inventory.txt
            echo "" >> cert-inventory.txt
          done

          echo "PKCS11 certificate inventory truncated" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          sed -n '1,260p' cert-inventory.txt >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Cleanup container
        if: always()
        shell: bash
        run: |
          docker rm -f signum-agent >/dev/null 2>&1 || true

      - name: Upload outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signum-pkcs11-output
          if-no-files-found: ignore
          path: |
            run-info.txt
            basic-checks.txt
            signum-container-status.txt
            pkcs11-module-error.txt
            pkcs11-module-missing.txt
            pkcs11-module-found.txt
            pkcs11-module-file.txt
            pkcs11-module-ls.txt
            pkcs11-modules-in-container.txt
            pkcs11-inventory-error.txt
            pkcs11-slots.txt
            pkcs11-certs.txt
            pkcs11-certs-with-pin.txt
            pkcs11-certs-all.txt
            pkcs11-object-ids.txt
            exported-certs/**
            cert-inventory.txt
            signum-agent-startup.log
            signum-pkcs11.so
