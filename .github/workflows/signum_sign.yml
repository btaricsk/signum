name: Signum PKCS11 discovery list certs

on:
  workflow_dispatch:
    inputs:
      signum_agent_image:
        description: "Agent container image to run include tag"
        required: false
        default: "keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1"
  push:
    branches: ["main"]
    paths:
      - "filestosign/**"
      - "pkcs11/**"

permissions:
  contents: read

jobs:
  pkcs11-discovery:
    runs-on: ubuntu-latest
    env:
      DEFAULT_SIGNUM_AGENT_IMAGE: keyfactor.jfrog.io/dev-oci/signum-agent:4.20.1
      PKCS11_MODULE_PATH: pkcs11/signum-pkcs11.so

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve agent image ref
        id: img
        shell: bash
        run: |
          set -euo pipefail
          IMG="${{ github.event.inputs.signum_agent_image }}"
          if [ -z "${IMG}" ]; then
            IMG="${DEFAULT_SIGNUM_AGENT_IMAGE}"
          fi
          echo "image=${IMG}" >> "$GITHUB_OUTPUT"
          echo "Using agent image: ${IMG}"

      - name: Validate PKCS11 module exists in repo
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f "${PKCS11_MODULE_PATH}" ]; then
            printf '%s\n' \
              "Missing PKCS11 module at ${PKCS11_MODULE_PATH}" \
              "This workflow expects the Signum PKCS11 .so to be committed into the repo under pkcs11/" \
              "Add pkcs11/signum-pkcs11.so (or update PKCS11_MODULE_PATH) and rerun" \
              | tee pkcs11-module-error.txt

            echo "PKCS11 module missing see artifact pkcs11-module-error.txt" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

          chmod 755 "${PKCS11_MODULE_PATH}" || true
          file "${PKCS11_MODULE_PATH}" | tee pkcs11-module-file.txt
          ls -la "${PKCS11_MODULE_PATH}"

      - name: Install PKCS11 tooling
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y opensc openssl

      - name: Start Signum Agent container
        shell: bash
        env:
          SIGNUM_HOSTNAME: ${{ secrets.SIGNUM_HOSTNAME }}
          SIGNUM_CLIENTID: ${{ secrets.SIGNUM_CLIENTID }}
          SIGNUM_USERNAME: ${{ secrets.SIGNUM_USERNAME }}
          SIGNUM_PASSWORD: ${{ secrets.SIGNUM_PASSWORD }}
          SIGNUM_AGENT_IMAGE: ${{ steps.img.outputs.image }}
        run: |
          set -euo pipefail

          echo "== Basic checks =="
          echo "Runner: $(uname -a)"
          echo "Docker: $(docker --version)"
          echo "SIGNUM_HOSTNAME set? $([[ -n "${SIGNUM_HOSTNAME:-}" ]] && echo yes || echo no)"
          echo "SIGNUM_CLIENTID set? $([[ -n "${SIGNUM_CLIENTID:-}" ]] && echo yes || echo no)"
          echo "SIGNUM_USERNAME set? $([[ -n "${SIGNUM_USERNAME:-}" ]] && echo yes || echo no)"
          echo "SIGNUM_PASSWORD set? $([[ -n "${SIGNUM_PASSWORD:-}" ]] && echo yes || echo no)"
          echo "== Image ref we will use =="
          echo "${SIGNUM_AGENT_IMAGE}"

          docker pull "${SIGNUM_AGENT_IMAGE}"
          docker rm -f signum-agent >/dev/null 2>&1 || true
          docker run --name signum-agent -d \
            -e "SIGNUM_HOSTNAME=$SIGNUM_HOSTNAME" \
            -e "SIGNUM_CLIENTID=$SIGNUM_CLIENTID" \
            -e "SIGNUM_USERNAME=$SIGNUM_USERNAME" \
            -e "SIGNUM_PASSWORD=$SIGNUM_PASSWORD" \
            -e "SIGNUM_LOGLEVEL=HIGH" \
            -e "SIGNUM_LOGTYPE=FILE" \
            "${SIGNUM_AGENT_IMAGE}"

          docker ps -a | sed -n '1,15p'
          docker logs signum-agent | tail -n 160 | tee signum-agent-startup.log || true

      - name: List all certificates via PKCS11
        shell: bash
        env:
          SIGNUM_PKCS11_PIN: ${{ secrets.SIGNUM_PKCS11_PIN }}
        run: |
          set -euo pipefail

          MODULE="$PWD/${PKCS11_MODULE_PATH}"

          echo "== pkcs11-tool list slots ==" | tee pkcs11-slots.txt
          pkcs11-tool --module "$MODULE" --list-slots | tee -a pkcs11-slots.txt

          echo "== pkcs11-tool list cert objects no login ==" | tee pkcs11-certs.txt
          pkcs11-tool --module "$MODULE" --list-objects --type cert 2>&1 | tee -a pkcs11-certs.txt || true

          echo "== pkcs11-tool list cert objects with login if pin provided ==" | tee pkcs11-certs-with-pin.txt
          if [ -n "${SIGNUM_PKCS11_PIN:-}" ]; then
            pkcs11-tool --module "$MODULE" --login --pin "$SIGNUM_PKCS11_PIN" --list-objects --type cert 2>&1 | tee -a pkcs11-certs-with-pin.txt || true
          else
            echo "No SIGNUM_PKCS11_PIN provided skipping login listing" | tee -a pkcs11-certs-with-pin.txt
          fi

          cat pkcs11-certs.txt pkcs11-certs-with-pin.txt 2>/dev/null > pkcs11-certs-all.txt || true

          IDS="$(awk '/^[[:space:]]*ID:/{print $2}' pkcs11-certs-all.txt | sort -u | tr -d '\r')"
          echo "$IDS" | tee pkcs11-object-ids.txt

          if [ -z "${IDS}" ]; then
            echo "No object IDs found inspect pkcs11-certs-all.txt" | tee pkcs11-inventory-error.txt
            exit 1
          fi

          mkdir -p exported-certs
          i=0
          for id in $IDS; do
            i=$((i+1))
            out="exported-certs/cert-${i}.der"
            if [ -n "${SIGNUM_PKCS11_PIN:-}" ]; then
              pkcs11-tool --module "$MODULE" --login --pin "$SIGNUM_PKCS11_PIN" \
                --read-object --type cert --id "$id" --output-file "$out" 2>/dev/null || true
            else
              pkcs11-tool --module "$MODULE" \
                --read-object --type cert --id "$id" --output-file "$out" 2>/dev/null || true
            fi
          done

          : > cert-inventory.txt
          for f in exported-certs/*.der; do
            [ -s "$f" ] || continue
            serial="$(openssl x509 -inform der -in "$f" -noout -serial | cut -d= -f2 | tr '[:lower:]' '[:upper:]')"
            thumb="$(openssl x509 -inform der -in "$f" -noout -fingerprint -sha1 | cut -d= -f2 | tr -d : | tr '[:lower:]' '[:upper:]')"
            subj="$(openssl x509 -inform der -in "$f" -noout -subject | sed 's/^subject=//')"
            issr="$(openssl x509 -inform der -in "$f" -noout -issuer  | sed 's/^issuer=//')"
            nb="$(openssl x509 -inform der -in "$f" -noout -startdate | cut -d= -f2)"
            na="$(openssl x509 -inform der -in "$f" -noout -enddate   | cut -d= -f2)"
            echo "$f" >> cert-inventory.txt
            echo "  serial:      $serial" >> cert-inventory.txt
            echo "  thumbprint:  $thumb" >> cert-inventory.txt
            echo "  notBefore:   $nb" >> cert-inventory.txt
            echo "  notAfter:    $na" >> cert-inventory.txt
            echo "  subject:     $subj" >> cert-inventory.txt
            echo "  issuer:      $issr" >> cert-inventory.txt
            echo "" >> cert-inventory.txt
          done

          echo "PKCS11 certificate inventory truncated" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          sed -n '1,240p' cert-inventory.txt >> "$GITHUB_STEP_SUMMARY" || true
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Cleanup container
        if: always()
        shell: bash
        run: |
          docker rm -f signum-agent >/dev/null 2>&1 || true

      - name: Upload outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: signum-pkcs11-output
          path: |
            pkcs11-module-error.txt
            pkcs11-module-file.txt
            pkcs11-inventory-error.txt
            pkcs11-slots.txt
            pkcs11-certs.txt
            pkcs11-certs-with-pin.txt
            pkcs11-certs-all.txt
            pkcs11-object-ids.txt
            exported-certs/
            cert-inventory.txt
            signum-agent-startup.log
